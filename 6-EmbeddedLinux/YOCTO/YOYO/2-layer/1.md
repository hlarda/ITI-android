# Layers

## Clone Poky

```bash
sudo apt install gawk wget git diffstat unzip texinfo gcc build-essential chrpath 
socat cpio python3 python3-pip python3-pexpect xz-utils debianutils iputils-ping 
python3-git python3-jinja2 libegl1-mesa libsdl1.2-dev xterm python3-subunit 
mesa-common-dev zstd liblz4-tool

sudo pip3 install GitPython pylint

git clone git://git.yoctoproject.org/poky -b kirkstone && cd poky
```

## configuration files

1. `.conf`
2. `.bb`
3. `.inc`
4. `.bbclass`
5. `.bbappend`
6. `meta-<layer-name>`

### Configuration files

1. `bblayers.conf`
   1. `BBLAYERS`: list of layers to be included in the build.
2. `local.conf`

    take a look at [poky/build/conf/local.conf](../../../../../../windows-a/poky/build/conf/local.conf) file. It is well documented.
   1. `MACHINE`: target machine.
   2. `DL_DIR`: default download directory. Any fetched source code will be stored here.

        ```console
        $ ls ~/windows-a/poky/build/downloads
        acl-2.3.1.tar.gz
        acl-2.3.1.tar.gz.done
        alsa-lib-1.2.6.1.tar.bz2
        alsa-lib-1.2.6.1.tar.bz2.done
        attr-2.5.1.tar.gz
        attr-2.5.1.tar.gz.done
        autoconf-2.71.tar.gz
        autoconf-2.71.tar.gz.done
        ```

        - during the build process, the source code will be fetched and stored in the `downloads` directory and the `.done` file will be created to indicate that the download is finished. If the `.done` file is not created, the source code will be fetched again.

        - If you build images for more than one machine, you can use a shared `DL_DIR` to avoid downloading the same source code multiple times.

        - git2 is used to fetch source code from git repositories.

            ```console
            $ ls ~/windows-a/poky/build/downloads/git2
            anongit.freedesktop.org.git.virglrenderer
            anongit.freedesktop.org.git.virglrenderer.done
            github.com.anholt.libepoxy
            github.com.anholt.libepoxy.done
            ```

3. `SSTATE_DIR`: The directory for the shared state cache.

    ```console
    $ ls build/sstate-cache/
    00  11  22  33  44  55  66  77  88  99  aa  bb  cc  dd  ee  ff
    01  12  23  34  45  56  67  78  89  9a  ab  bc  cd  de  ef  universal
    02  13  24  35  46  57  68  79  8a  9b  ac  bd  ce  df  f0
    03  14  25  36  47  58  69  7a  8b  9c  ad  be  cf  e0  f1
    04  15  26  37  48  59  6a  7b  8c  9d  ae  bf  d0  e1  f2
    ```

    - Each task that is run during the build process will be stored in the `sstate-cache` directory. If the same task is run again, the result will be fetched from the cache.
    - `fzf` at `build/sstate-cache/` and search for the tasks like fetch, unpack, patch, configure, compile, install, package, and populate_sdk.

4. `TMPDIR`: The directory for temporary files. Make it shared as done for `DL_DIR` to avoid multiplications.

    ```console
    $ ls poky/build/tmp/
    abi_version  hosttools     sstate-control       work
    buildstats   log           stamps               work-shared
    cache        pkgdata       sysroots-components
    deploy       saved_tmpdir  sysroots-uninative
    ```

5. `DISTRO`: The distribution to be used. The distribution setting controls which policy settings are used as defaults. The default value is fine for general Yocto project use, at least initially. Ultimately when creating custom policy, people will likely end up subclassing these defaults.[meta-poky/conf/distro/poky.conf](https://git.yoctoproject.org/cgit/cgit.cgi/poky/tree/meta-poky/conf/distro/poky.conf)

> - These local variables are used to configure the build process and not accessible from terminal. If you tried to echo them, you will get an empty string.
>
> - Variables which can be accessed from the terminal are defined in `oe-init-build-env` script.
> To print all environment variables, run `bitbake -e`

#### 2. [poky/meta/conf/bitbake.conf](../../../../../../windows-a/poky/meta/conf/bitbake.conf)

#### 3. [poky/build/conf/bblayers.conf](../../../../../../windows-a/poky/build/conf/bblayers.conf)

#### MACHINE, DISTRO and IMAGE

- `MACHINE_FEATURES`: basic configuration of the target machine.
- `DISTRO_FEATURES`: basic configuration of the distribution.
- `IMAGE_FEATURES`: add to the basic distro features to create a specific image such as gui or cli image.

## Recipes

- It is a set of instructions to build a package. It is written in `.bb` files.
- It is a set of tasks to be executed in a specific order.
- It is BitBake's way of understanding how to build a package.

1. Naming convention

    It is specified in [/home/hala/windows-a/poky/meta/recipes.txt](../../../../../../windows-a/poky/meta/recipes.txt). `recipes-` followed by recipes category(bsp, connectivity, core, devtools, extended, gnome, graphics, kernel, multimedia, rt, sato, support)

2. Recipes provide:
   1. Tasks to be executed(configure, compile, install)
   2. Variables to be set(LICENSE, SRC_URI, RDEPENDS)

3. [poky/meta-skeleton](../../../../../../windows-a/poky/meta-skeleton) is a directory provides templates for creating a new layer.

### create first recipe

#### Hello Python

1. Creating recipes in meta is a bad practice, we will fix this later.

    ```cmd
    cd poky/meta
    mkdir -p recipes-hello/hello-python && cd resipes-hello/hello-python
    code hello-python.bb
    ```

2. [hello-python.bb](/6-EmbeddedLinux/YOCTO/YOYO/2-layer/recipes-hello/hello-python/hello-python.bb)

Then run `bitbake hello-python` to build the recipe.

```console
NOTE: Executing Tasks
WARNING: hello-python-1.0-r0 do_configure: do_configure
WARNING: hello-python-1.0-r0 do_compile: do_compile
WARNING: hello-python-1.0-r0 do_install: do_install
```

#### Hello C

1. Create a new recipe for a simple C program.
    1. [main.c](/6-EmbeddedLinux/YOCTO/YOYO/2-layer/recipes-hello/hello-c/files/main.c)
    2. [hello-c.bb](/6-EmbeddedLinux/YOCTO/YOYO/2-layer/recipes-hello/hello-c/hello-c.bb)

    ```bash
    cd poky/meta
    mkdir -p recipes-hello/hello-c && cd recipes-hello/hello-c
    code main.c
    code hello-c.bb
    ```

2. create file named `files` and add `main.c` to avoid the error `ERROR: hello-c-1.0-r0 do_fetch: Fetcher failure: Unable to find file file://main.c anywhere.`.

    ```bash
    mkdir files
    mv main.c files
    ```

3. Run `bitbake hello-c`
4. Check the output.

    ```console
    $ ls /home/hala/windows-a/poky/build/tmp/work/cortexa57-poky-linux/hello-c/1.0-r0/image/usr/bin
    hello
    ```

5. The steps before build the recipe but wont include it in the image. To do this: at `core-image-minimal.bb` add `IMAGE_INSTALL = "packagegroup-core-boot ${CORE_IMAGE_EXTRA_INSTALL} hello-c"`. Then run `bitbake core-image-minimal`.

6. Run QEMU and check the output.

    ```console
    runqemu qemuarm64 nographic
    ```

    ```qemu
    root@qemuarm64:~# hello 
    Hello C Recipe
    CONFIG_VALUE: 10
    ```

### Create a new layer

Previously, we created recipes in the `meta` layer. This is not a good practice. We should create a new layer for our recipes. from now on, we will create a new layer for our recipes using `bitbake-layers`.

1. **`bitbake-layers`** is a utility that allows you to manipulate the layer configuration of a BitBake build.

    ```console
    $ bitbake-layers --help
    NOTE: Starting bitbake server...
    usage: bitbake-layers [-d] [-q] [-F] [--color COLOR] [-h] <subcommand> ...

    BitBake layers utility

    options:
      -d, --debug           Enable debug output
      -q, --quiet           Print only errors
      -F, --force           Force add without recipe parse verification
      --color COLOR         Colorize output (where COLOR is auto, always, never)
      -h, --help            show this help message and exit

    subcommands:
      <subcommand>
        add-layer           Add one or more layers to bblayers.conf.
        remove-layer        Remove one or more layers from bblayers.conf.
        flatten             flatten layer configuration into a separate output directory.
        show-layers         show current configured layers.
        show-overlayed      list overlayed recipes (where the same recipe exists in
                            another layer)
        show-recipes        list available recipes, showing the layer they are provided
                            by
        show-appends        list bbappend files and recipe files they apply to
        show-cross-depends  Show dependencies between recipes that cross layer
                            boundaries.
        layerindex-fetch    Fetches a layer from a layer index along with its dependent
                            layers, and adds them to conf/bblayers.conf.
        layerindex-show-depends
                            Find layer dependencies from layer index.
        create-layer        Create a basic layer

    Use bitbake-layers <subcommand> --help to get help on a specific command
    ```

    `--help` can be used with any subcommand to get help on a specific command. lets try `create-layer`.

    ```console
    $ bitbake-layers create-layer  --help
    NOTE: Starting bitbake server...
    usage: bitbake-layers create-layer [-h] [--layerid LAYERID] [--priority PRIORITY]
                                       [--example-recipe-name EXAMPLERECIPE]
                                       [--example-recipe-version VERSION]
                                       layerdir

    Create a basic layer

    positional arguments:
      layerdir              Layer directory to create

    options:
      -h, --help            show this help message and exit
      --layerid LAYERID, -i LAYERID
                            Layer id to use if different from layername
      --priority PRIORITY, -p PRIORITY
                            Priority of recipes in layer
      --example-recipe-name EXAMPLERECIPE, -e EXAMPLERECIPE
                            Filename of the example recipe
      --example-recipe-version VERSION, -v VERSION
                            Version number for the example recipe
    ```

#### Usage

```bash
. oe-init-build-env rpi3_build
bitbake-layers create-layer ../meta-custom
bitbake-layers show-layers
bitbake-layers add-layer ../meta-custom
bitbake-layers show-layers
```

> I've cancelled last 30 minutes of the video. I will return to it later.
