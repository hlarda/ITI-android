# Building Image for Raspberry Pi3B+ using Yocto

## 1. Clone the poky repository

[Yocto Documentation Install Guide.](https://docs.yoctoproject.org/brief-yoctoprojectqs/index.html)

## 2. Install PI Board Support Package (BSP)

inside `poky` directory, run the following command to install the BSP for Raspberry Pi 3:

```cmd
git clone https://github.com/agherzan/meta-raspberrypi.git -b kirkstone
```

## 3. Source the environment

```cmd
source oe-init-build-env
```

## 4. Add the meta-raspberrypi layer

Append the layer to the `bblayers.conf` file located in the `build` directory to `BBLAYERS` variable manually or using the following command:

```cmd
bitbake-layers add-layer ../meta-raspberrypi
```

```console
$ bitbake-layers show-layers
NOTE: Starting bitbake server...
layer                 path                                      priority
==========================================================================
meta                  /home/hala/windows-a/pi-sato/poky/meta    5
meta-poky             /home/hala/windows-a/pi-sato/poky/meta-poky  5
meta-yocto-bsp        /home/hala/windows-a/pi-sato/poky/meta-yocto-bsp  5
meta-raspberrypi      /home/hala/windows-a/pi-sato/poky/meta-raspberrypi  9
```

**ALL THE FOLLOWING STEPS ARE DONE IN THE `local.conf` FILE** till knowing the best location for each configuration.

## 5. Set the machine

choose one of the supported machines from `poky/meta-raspberrypi/docs/layer-contents.md`

```recipe
MACHINE = "raspberrypi3-64"
```

## 6. Image file system

```recipe
IMAGE_FSTYPES = "tar.xz ext4 rpi-sdimg" 
```

## 7. Add shared directories for temp files

```recipe
MUTUAL_TEMP = "/home/hala/windows-a/pi-sato/tmp-poky"
SSTATE_DIR ?= "${MUTUAL_TEMP}/sstate-cache"
DL_DIR ?= "${MUTUAL_TEMP}/downloads"
TMPDIR = "${MUTUAL_TEMP}/tmp"
```

## 8. systemd for the image

```recipe
DISTRO_FEATURES:append = " systemd"
VIRTUAL-RUNTIME_init_manager = "systemd"
VIRTUAL-RUNTIME_initscripts = ""
```

## 9. Install some dropbear and enable UART

`dropbear`: A lightweight SSH server, which is useful for remote management.

```recipe
IMAGE_INSTALL:append = " dropbear systemd systemd-serialgetty"
ENABLE_UART = "1"
```

## 10. Remove temporary files after building

```recipe
INHERIT = "rm_work"
```

## 11. Enable multi-threading in building

```recipe
# Multi-threading
BB_NUMBER_THREADS = "7"
PARALLEL_MAKE = "-j 7"
```

## 12. Build the image

`core-image-sato` is a lightweight graphical image recipe.

```cmd
bitbake core-image-sato
```
