# Building Image for Raspberry Pi 3B+ using Yocto

## 1. Clone the Poky Repository

Follow the [Yocto Documentation Install Guide](https://docs.yoctoproject.org/brief-yoctoprojectqs/index.html) to clone the Poky repository.

## 2. Install PI Board Support Package (BSP)

Inside the `poky` directory, run the following command to install the BSP for Raspberry Pi 3:

```bash
git clone https://github.com/agherzan/meta-raspberrypi.git -b kirkstone
```

## 3. Source the Environment

Run the following command to set up the build environment:

```bash
source oe-init-build-env
```

## 4. Add the Meta-RaspberryPi Layer

Append the layer to the `bblayers.conf` file located in the `build` directory. You can do this manually or by using the following command:

```bash
bitbake-layers add-layer ../meta-raspberrypi
```

To verify adding the layer, run:

```console
bitbake-layers show-layers
```

**The following steps are done in the `local.conf` file** until the best location for each configuration is determined.

## 5. Set the Machine

Choose one of the supported machines from `poky/meta-raspberrypi/docs/layer-contents.md` and add it to the `local.conf` file:

```conf
MACHINE = "raspberrypi3-64"
```

## 6. Add Shared Directories for Temporary Files

Add the following to the `local.conf` file to set shared directories:

```conf
MUTUAL_TEMP = "/home/hala/windows-a/pi-sato/tmp-poky"
SSTATE_DIR ?= "${MUTUAL_TEMP}/sstate-cache"
DL_DIR ?= "${MUTUAL_TEMP}/downloads"
TMPDIR = "${MUTUAL_TEMP}/tmp"
```

## 7. Enable Multi-threading in Building

Add the following to the `local.conf` file to enable multi-threading:

```conf
BB_NUMBER_THREADS = "7"
PARALLEL_MAKE = "-j 7"
```

---

## Additional Steps for Custom Layer and Distro

### 1. Create a Layer

Run the following commands to create a custom layer:

```bash
. oe-init-build-env rpi3_build
bitbake-layers create-layer ../meta-custom
bitbake-layers show-layers
bitbake-layers add-layer ../meta-custom
bitbake-layers show-layers
```

### 2. Create an Image Within Your Layer (Sato Image)

Navigate to the build directory and create an image recipe:

```bash
cd poky/build
mkdir -p ../meta-custom/recipes-core/images && code ../meta-custom/recipes-core/images/custom-image.bb
```

Add the following content to the `custom-image.bb` file:

```recipe
inherit core-image
include recipes-sato/images/core-image-sato.bb

IMAGE_FEATURES += " ssh-server-dropbear "
IMAGE_INSTALL += " strace "
```

### 3. Create a `.bbappend` File

To add specific configuration without affecting the original recipe, create a `.bbappend` file:

```bash
cd poky/meta-custom
mkdir -p recipes-core/base-files && code recipes-core/base-files/base-files_%.bbappend
```

Add the following content:

```recipe
hostname = "custom-hostname"
```

To display which files append to the base-files recipe, run:

```bash
bitbake-layers show-appends base-files
```

### 4. Create a Distro

Create a custom distribution configuration file:

```bash
cd poky
mkdir -p meta-custom/conf/distro && code meta-custom/conf/distro/custom-distro.conf
```

Add the following content:

```recipe
require conf/distro/poky.conf
DISTRO = "custom-distro"
DISTRO_NAME = "Custom Distro Version 1.0"
DISTRO_VERSION = "1.0"
DISTRO_FEATURES:remove = "ext2 3g nfc"
INIT_MANAGER = "systemd"
ENABLE_UART = "1"
```

Set the distro in the `local.conf` file:

```conf
DISTRO ?= "custom-distro"
```

### 5. Download the Meta Layer for the BSP

If not already done, download the meta layer for Raspberry Pi BSP:

```bash
git clone https://github.com/agherzan/meta-raspberrypi.git -b kirkstone
```

### 6. Add BSP to Layers

Add the BSP layer:

```bash
bitbake-layers add-layer ../meta-raspberrypi
```

### 7. Add Machine Name to `local.conf`

Ensure the machine name is set in the `local.conf` file:

```conf
MACHINE = "raspberrypi3-64"
```

### 8. Build the Custom Image

Finally, build the custom image using the command:

```bash
bitbake custom-image
```

This will create an image that includes all the features of the core-image-sato with your additional customizations.
